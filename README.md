# 東証障害を越えて

2020 10/1 の東証障害でもわかる通り、能力・コストを掛けても避けられない障害は存在する。
この障害は、2台ある共有ディスクの一方にメモリ故障が発生したものの、フェイルオーバに失敗し、業務停止となった と発表されている。

2020 10/19 の東証発表では NetApp (ONTAP) の設定が update の過程で フェイルオーバしない設定に変えられていたのを見逃した、ということであった。
マクロに見れば「ストレージが ヒトと合意せずに状態遷移をしたために、ヒトの認識との一貫性が失われた」といえる。

このシステムを使って 合意問題 を直観的に理解するために以下のようにモデル化する。

- 隣あった2つの部屋に Aさん Bさん がそれぞれ入る。
- Aさん Bさんは互いの声は聞こえるが、互いの様子を見ることはできない。
- 二人に問題Qが与えられ、二人が同じ解に到達したら解Rを返す。

```
         Q
         ↓

   +---+   +---+
   |   |   |   |
   | A |   | B |
   |   |   |   |
   +---+   +---+

         ↓
         R
```
A, B は共有ディスクをモデル化した、
A, B の会話は 共有ディスク間の通信 をモデル化した、
に過ぎない。

このシステムから 毎回 確実 に解を得る方法は実現不可能ということが [二人の将軍問題](https://ja.wikipedia.org/wiki/%E4%BA%8C%E4%BA%BA%E3%81%AE%E5%B0%86%E8%BB%8D%E5%95%8F%E9%A1%8C) として知られている。

これは簡単な思考実験で直観的に理解できる。
Aは自分の解 とBの解が同じであることを確認するために 「おーい 、君の答えは R かい?」とBに問いかける。しかし B が直ぐに反応するとは限らない。Bは

- 問題を解いている最中かもしれない
- Aの声が聞こえなかったのかもしれない
- 寝ているかもしれない、
- 死んでいるかもしれない

更には、両者とも

- 自分が相手の声を聞き逃したことは気付けない
- 自分が寝ていることは気付けない
- 自分が死んでいることは気付けない

# 故障とは何か

一口に故障といっても色々な種類があるが、ここでは二種類に分ける。

1. 反応が無くなる
2. 期待しない反応をする

コの世界では、1 をクラッシュ故障、2をビザンチン故障 と呼ぶ。

大雑把に「壊れたら動かなくなる故障」がクラッシュ故障で 「壊れても動いている故障」をビザンチン故障と考えてよい。

ビザンチン故障には処理遅延、パケットロスト、不正または一貫しない応答、などが含まれる。

先ほどのモデルで言うと

- 問題を解いている最中 = 処理遅延
- Aの声が聞こえない = パケットロスト
- 寝ている = 一貫しない応答 (寝ている間は応答しないが、起きれば応答する)

これらはビザンチン故障だ。
